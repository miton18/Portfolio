(function(){var e,n,o,t,r,i,s,a,u,l,c;a=require("express"),t=require("body-parser"),n=require("basic-auth"),r=require("compression"),c=require("tingodb")().Db,s=require("child_process").exec,l=80|process.env.npm_package_config_port,e=a(),e.listen(l),console.log("starting on "+l),i=new c("./data",{nativeObjectID:!0}),u=i.collection("messages"),o=function(e,o,t){var r,i;return r=function(e){return e.set("WWW-Authenticate","Basic realm=Authentification requise"),e.sendStatus(401)},i=n(e),(null==i||null==i.name||null==i.pass)&&r(o),"miton"===i.name&&"notim"===i.pass?t():r(o)},e.use(t.urlencoded({extended:!0})),e.use(t.json()),e.use(r()),e.use("/",a["static"](__dirname+"/build")),e.post("/update",function(e,n){var o,t,r,i;if(e.body.ref){i=e.body.ref,r="";try{s("git pull origin V3",function(e,n,o){e&&(r+=e),n&&(r+=n),o&&(r+=o)})}catch(t){o=t,r+=o}n.send("Update to: "+i+" "+r)}}),e.get("/messages",o,function(e,n){return u.find({}).toArray(function(e,o){return e||n.json(o),n.json(e)})}),e.post("/messages",function(e,n){var o,t,r,i,s;return null!=e.body.email&&(t=e.body.email),null!=e.body.content&&(o=e.body.content),null!=e.body.name&&(i=e.body.name),r=e.headers["X-Forwarded-For"]||e.headers["x-forwarded-for"]||e.client.remoteAddress,null==t||null==o||null==i?void n.json({error:"bad request"}):(s=/^[0-9a-z._-]+@{1}[0-9a-z.-]{2,}[.]{1}[a-z]{2,5}$/i,s.test(t)?u.insert({email:t,content:o,time:Date.now(),ip:r},function(e,o){return null!=e?n.json({error:e}):n.json({id:o[0]._id})}):void n.json({error:"bad email"}))}),process.on("uncaughtException",function(e){console.log("Caught exception: "+e)})}).call(this);
